package com.liwinon.phoneScanning.QiyeWX.api;

import java.nio.charset.Charset;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.transaction.Transactional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.liwinon.phoneScanning.QiyeWX.dao.MembersDao;
import com.liwinon.phoneScanning.QiyeWX.dao.WXdao;
import com.liwinon.phoneScanning.QiyeWX.entity.AccessToken;
import com.liwinon.phoneScanning.QiyeWX.entity.Members;
import com.liwinon.phoneScanning.QiyeWX.util.WXUtils;
import com.liwinon.phoneScanning.service.UtilService;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

@Service
public class WxServiceImpl implements WxService {
	@Autowired
	private UtilService util;
	@Autowired
	private WXdao wxdao;
	@Autowired
	private MembersDao mdao;

	public static String Corpid = "wwbc7acf1bd2c6f766"; // 企业ID
	private static String AppID = "1000011"; // 应用ID
	private static String Secret = "i2OLTe-rsYM4neNZrALf9HAP1xUEonqUQaKUFeWHHKI"; // 应用Secret
	private static String MembersSecret = "krcdN2IA2HiZ6BOjQ0-MhNwAEIQCtN8-dWIx_25hjCs"; // 通讯录Secret

	public static String XWDCorpid = "wxcce8da13c9b0ed5b";
	private static String XWDAppID = "1000048";
	public static String XWDSecret = "HfxSUCttcXhsosCIiV_tZR-QJzl_KbI9K9eZB6UlTzc";

	private static String XWDApiGetBirthday = "http://appinter.sunwoda.com/weixin/blessing/findBirthdayUserNow.json";
	private static String XWDApiGetAnniversary = "http://appinter.sunwoda.com/weixin/blessing/findAnniversaryUserNow.json";
	// private static String url = "localhsot";
	private static String url = "https://mesqrcode.liwinon.com/phone";

	/**
	 * 
	 * @param secret Secret是获取正常token ， MembersSecret 获取通讯录token
	 * @param type   分为普通token（0），和通讯录token（1）
	 * @return
	 */
	public AccessToken token(String secret, int type, String Corpid) { //
		// {"errcode":0,"errmsg":"ok","access_token":"91-FR....jw","expires_in":7200}
		JSONObject json = JSONObject.fromObject(WXUtils.getAccess_token(Corpid, secret));
		AccessToken token = new AccessToken();
		token.setAccess_token(json.getString("access_token"));
		token.setExpires_in(json.getInt("expires_in"));
		token.setType(type);
		Calendar now = Calendar.getInstance();
		now.add(Calendar.SECOND, json.getInt("expires_in"));
		token.setInvalidTime(now.getTime());
		System.out.println("token:" + token);
		return token;
	}

	@Transactional
	/**
	 * * @param secret Secret是获取正常token ， MembersSecret 获取通讯录token
	 * 
	 * @param type 分为普通token（0），和通讯录token（1）
	 * @return
	 */
	public AccessToken getUsefulToken(String secret, int type, String appid, String Corpid) {
		AccessToken token = wxdao.findMax(type);
		if (token == null) {
			token = token(secret, type, Corpid);
			wxdao.save(token);
			return token;
		}
		if (type == 0) {
			/*
			 * 测试token 的api
			 * https://qyapi.weixin.qq.com/cgi-bin/agent/get?access_token=ACCESS_TOKEN&
			 * Corpid=Corpid =USERID
			 */
			JSONObject json = JSONObject.fromObject(util.reqGet("https://qyapi.weixin.qq.com/cgi-bin/agent/get",
					"access_token=" + token.getAccess_token() + "&agentid=" + appid));
			if (!"0".equals(json.getString("errcode"))) { // 只有0 是成功
				token = token(secret, type, Corpid);
				wxdao.save(token);
				return token;
			}
		} else if (type == 1) { // 获取通讯录 token
//			String s  = util.reqGet("https://qyapi.weixin.qq.com/cgi-bin/user/get",
//					"access_token=" + token.getAccess_token() + "&userid=XiongJianLin");
//			System.out.println("------------------"+s);
			JSONObject json = JSONObject.fromObject(util.reqGet("https://qyapi.weixin.qq.com/cgi-bin/user/get",
					"access_token=" + token.getAccess_token() + "&userid=1902268014"));
			if (!"0".equals(json.getString("errcode"))) {
				token = token(secret, type, Corpid);
				wxdao.save(token);
				return token;
			}
		}
		return token;
	}

	/**
	 * 发送生日祝福 ---- 锂威能源企业微信
	 */
	@Override
	public String sendBirthdayMsg() {
		Calendar cal = Calendar.getInstance();
		int month = cal.get(Calendar.MONTH) + 1;
		int day = cal.get(Calendar.DAY_OF_MONTH);
		String birthday = String.valueOf(month) + "-" + String.valueOf(day);
		SimpleDateFormat sdf = new SimpleDateFormat("MM-dd");
		List<Members> members = null;
		try {
			Date birth = sdf.parse(birthday);
			// System.out.println(birth);
			members = mdao.findByDate(birth);
		} catch (ParseException e) {
			e.printStackTrace();
		}
		if (members.isEmpty()) {
			System.out.println("今天没有人过生");
			return "今天没有人过生。";
		} else {
			// Map<String, String> param = new HashMap<String, String>();
			AccessToken token = getUsefulToken(Secret, 0, AppID, Corpid);
			for (Members m : members) {
				// param.put(m.getUserid(),m.getName());
				String userid = m.getUserid();
				String name = m.getName();
				return WXSendbirth(userid, name, token, AppID); // 调用发送
			}

		}

		return null;
	}

	/**
	 * 发送生日祝福 ---- 欣旺达企业微信
	 * 
	 * @return
	 */
	public String sendBirthdayMsgToXWD() {
		// 第一个请求用于测试最大条数.
		String test = util.reqGet(XWDApiGetBirthday, "page=1&pageSize=1");
		if (test != null && test != "") {
			JSONObject json = JSONObject.fromObject(test);
			System.out.println(json);
			if (json.getInt("statusCode") != 0)
				return "请求数据失败!";
			JSONObject pageInfo = json.getJSONObject("dataInfo").getJSONObject("pageInfo");
			int totalRecord = pageInfo.getInt("totalRecord"); // 获取到了最大条数
			// 正式请求 //第二次请求获取所有数据
			JSONObject births = JSONObject.fromObject(util.reqGet(XWDApiGetBirthday, "page=1&pageSize=" + totalRecord));
			if (births.getInt("statusCode") != 0)
				return "请求数据失败!";
			JSONArray arrs = births.getJSONObject("dataInfo").getJSONArray("listData");
			System.out.println("全部数据:" + arrs);
			if (arrs.size() > 0) {
				System.out.println(arrs.size());
				AccessToken token = getUsefulToken(XWDSecret, 0, XWDAppID, XWDCorpid); // 获取欣旺达应用的token
				SimpleDateFormat sdf = new SimpleDateFormat("MM-dd");
				for (int i = 0; i < arrs.size(); i++) {
					JSONObject job = arrs.getJSONObject(i); // 遍历 jsonarray 数组，把每一个对象转成 json 对象
					String company = job.getString("orgName");
					if ("惠州锂威新能源科技有限公司".equals(company) || "东莞锂威能源科技有限公司".equals(company)) {
						String userid = job.getString("userNo");
						String name = job.getString("name");
						String birth = job.getString("blessingsStr");
						/**保存用户*/
						Members it ;
						if(mdao.findByUserid(userid)!=null) {
							it = mdao.findByUserid(userid);
						}else {
							it = new Members();
						}
						//无论如何都更新信息
						it.setUserid(userid);
						it.setName(name);
						try {
							String[] array = birth.split("-");
							Date birthday = sdf.parse(array[1] + "-" + array[2]);
							it.setBirthday(birthday);
						} catch (ParseException e) {
							System.out.println("转换日期出错");
							e.printStackTrace();
						}
						mdao.save(it);
						/**保存结束*/
						
						// 发送生日祝福, 其余不管,交由另一个方法处理
						System.out.println("正在给 " + job.getString("name") + " 发送祝福");

						WXSendbirth(userid, name, token,XWDAppID);
					}
				}
				/* 测试代码 */
				//WXSendbirth("1902268014", "熊健淋", token, XWDAppID);
				//WXSendbirth("E14995", "周芳", token, XWDAppID);
				return "发送成功!";
			}

		} else {
			System.out.println("return:" + test);
			return "sunwoda接口获取生日失败!";
		}

		return null;
	}

	/** 发送生日方法 */
	private String WXSendbirth(String userid, String name, AccessToken token, String appid) {
		System.out.println("开始发送生日祝福");
		Map<String, Object> resultMap = new HashMap<String, Object>();
		Map<String, Object> secondtMap = new HashMap<String, Object>(); // 浜岀骇json
		Map<String, String> thirdMap = new HashMap<String, String>(); // 浜岀骇json
		resultMap.put("touser", userid);
		resultMap.put("msgtype", "news");
		resultMap.put("agentid", appid); // 应用ID
		thirdMap.put("title","亲爱的" + name + "     祝你生日快乐!");
		thirdMap.put("description", "今天是你的生日，不要忘记哦！"); // 描述
		thirdMap.put("url", url + "/birthday?" + "name=" + name); // 点击后跳转的网页
		thirdMap.put("picurl", "https://mesqrcode.liwinon.com/img/bithPic.jpg"); // 图片路径
		List<Map<String, String>> list = new ArrayList<Map<String, String>>();
		list.add(thirdMap);
		secondtMap.put("articles", list);
		resultMap.put("news", secondtMap);
		JSONObject json = JSONObject.fromObject(resultMap);
		String param = json.toString();
		//System.out.println("json:" + param);
		JSONObject res = JSONObject.fromObject(util.reqPost(
				"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=" + token.getAccess_token(), param));
		System.out.println("WX返回的：" + res);
		if (!"0".equals(res.getString("errcode"))) {
			return name + " 发送生日祝福失败，请联系管理员";
		}
		return "发送成功";
	}

	/**
	 * 根据发送入职提醒
	 * 
	 * @param pastday 已经入职的天数
	 * @return
	 */
	public String sendEntryMsg(int pastday) {
		List<Members> members = null;
		Date entryday = WXUtils.getPastDate(pastday);
		System.out.println("入职时间:" + entryday);
		Calendar cal1 = Calendar.getInstance();
		cal1.setTime(entryday);
		// 将时分秒,毫秒域清零
		cal1.set(Calendar.HOUR_OF_DAY, 0);
		cal1.set(Calendar.MINUTE, 0);
		cal1.set(Calendar.SECOND, 0);
		cal1.set(Calendar.MILLISECOND, 0);
		members = mdao.findByEntryTime(cal1.getTime());
		if (members.isEmpty()) {
			System.out.println("没有入职x天的人");
			return "今天没有已经入职" + pastday + "天的人";
		} else {
			return sendTextCardMsg(
					members, "入职通知", "<div class=\"normal\">您好，您已入职</div>" + "<div class=\"highlight\">" + pastday
							+ "天</div>" + "<div class=\"normal\">请及时与直属领导沟通并完成入职流程。</div>",
					url + "/EntryInfo", "查看详情", AppID);
		}
	}

	/**
	 * 发送文本卡片消息
	 * 
	 * @param members
	 * @return
	 */
	public String sendTextCardMsg(List<Members> members, String title, String description, String url, String btntxt,
			String appid) {
		// Map<String, String> param = new HashMap<String, String>();
		System.out.println("开始准备发送入职通知");
		AccessToken token = getUsefulToken(Secret, 0, appid, Corpid);
		for (Members m : members) {
			// param.put(m.getUserid(),m.getName());
			String userid = m.getUserid();
			String name = m.getName();
			WXSendEntry(userid, name, token, appid, title, description,url, btntxt);
		}
		return null;
	}

	/** 发送给欣旺达入职推送 */
	public String sendEntryMsgToXWD(int pastday) {
		// Map<String, String> param = new HashMap<String, String>();
//				"入职通知", "<div class=\"normal\">您好，您已入职</div>" + "<div class=\"highlight\">" + pastday
//						+ "天</div>" + "<div class=\"normal\">请及时与直属领导沟通并完成入职流程。</div>",
//				url + "/EntryInfo", "查看详情", AppID);
		String title="入职通知";
		String description = "<div class=\"normal\">您好，您已入职</div>"  + "<div class=\"normal\">请及时与直属领导沟通并完成入职流程。</div>";
		String URL = url + "/EntryInfo";
		String btntxt = "查看详情";
		System.out.println("开始准备发送入职通知");
		// 第一个请求用于测试最大条数.
		String test = util.reqGet(XWDApiGetAnniversary, "page=1&pageSize=1");
		if (test != null && test != "") {
			JSONObject json = JSONObject.fromObject(test);
			System.out.println(json);
			if (json.getInt("statusCode") != 0)
				return "请求数据失败!";
			JSONObject pageInfo = json.getJSONObject("dataInfo").getJSONObject("pageInfo");
			int totalRecord = pageInfo.getInt("totalRecord"); // 获取到了最大条数
			// 正式请求 //第二次请求获取所有数据
			JSONObject entrys = JSONObject.fromObject(util.reqGet(XWDApiGetAnniversary, "page=1&pageSize=" + totalRecord));
			if (entrys.getInt("statusCode") != 0)
				return "请求数据失败!";
			JSONArray arrs = entrys.getJSONObject("dataInfo").getJSONArray("listData");
			System.out.println("全部数据:" + arrs);
			if (arrs.size() > 0) {
				System.out.println(arrs.size());
				AccessToken token = getUsefulToken(XWDSecret, 0, XWDAppID, XWDCorpid); // 获取欣旺达应用的token
				Date date = new Date();
		        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
		        String now = sdf.format(date);
		        System.out.println("今天是:"+now);
				for (int i = 0; i < arrs.size(); i++) {
					JSONObject job = arrs.getJSONObject(i); // 遍历 jsonarray 数组，把每一个对象转成 json 对象
					String company = job.getString("orgName");
					String entryDate = job.getString("blessingsStr");
					if ("惠州锂威新能源科技有限公司".equals(company) || "东莞锂威能源科技有限公司".equals(company)) {
						System.out.println(company);
						String userid = job.getString("userNo");
						String name = job.getString("name");
						/**保存用户*/
						Members it ;
						if(mdao.findByUserid(userid)!=null) {
							it = mdao.findByUserid(userid);
						}else {
							it = new Members();
						}
						//无论如何都更新信息
						String entryTime = job.getString("blessingsStr");
						it.setUserid(userid);
						it.setName(name);
						try {
							it.setEntryTime(sdf.parse(entryTime));
						} catch (ParseException e) {
							System.out.println("转换日期出错");
							e.printStackTrace();
						}
						mdao.save(it);
						/**保存结束*/
						/**发送今天刚入职的人*/
						if(now.equals(entryDate)) {  //今天刚入职
							// 发送入职推送
							System.out.println("正在给 " + job.getString("name") + " 发送入职推送");
							WXSendEntry(userid, name, token, XWDAppID, title, description,URL, btntxt);
						}
					}
				}
				/* 测试代码 */
				//WXSendEntry("1902268014", "熊健淋", token, XWDAppID, title, description,URL, btntxt);
				//WXSendEntry("E14995", "周芳", token, XWDAppID, title, description,URL, btntxt);
				/**发送给入职X天的人, 只能从系统运行之日起,获取接口传来的数据.*/
				List<Members> members = null;
				Date entryday = WXUtils.getPastDate(pastday);
				System.out.println("入职时间:" + entryday);
				Calendar cal1 = Calendar.getInstance();
				cal1.setTime(entryday);
				// 将时分秒,毫秒域清零
				cal1.set(Calendar.HOUR_OF_DAY, 0);
				cal1.set(Calendar.MINUTE, 0);
				cal1.set(Calendar.SECOND, 0);
				cal1.set(Calendar.MILLISECOND, 0);
				members = mdao.findByEntryTime(cal1.getTime());
				if (members.isEmpty()) {
					System.out.println("没有入职x天的人");
					return "今天没有已经入职" + pastday + "天的人";
				} else {
					String descriptionXday = "<div class=\"normal\">您好，您已入职</div>" + "<div class=\"highlight\">" + pastday
							+ "天</div>" + "<div class=\"normal\">请及时与直属领导沟通并完成入职流程。</div>";
					for (Members m : members) {
						// param.put(m.getUserid(),m.getName());
						String userid = m.getUserid();
						String name = m.getName();
						WXSendEntry(userid, name, token, XWDAppID, title, descriptionXday,URL, btntxt);
					}
				}
			}

		} else {
			System.out.println("return:" + test);
			return "sunwoda接口获取生日失败!";
		}

		return null;
		
	}

	/** 发送卡片信息 */
	private String WXSendEntry(String userid, String name, AccessToken token, String appid, String title,
			String description, String URL,String btntxt) {

		Map<String, Object> resultMap = new HashMap<String, Object>();
		Map<String, Object> secondtMap = new HashMap<String, Object>(); // json
		resultMap.put("touser", userid);
		resultMap.put("msgtype", "textcard");
		resultMap.put("agentid", appid);
		secondtMap.put("title", title);
		secondtMap.put("description", description);
		secondtMap.put("url", URL + "?name=" + name);
		secondtMap.put("btntxt", btntxt);
		resultMap.put("textcard", secondtMap);
		JSONObject json = JSONObject.fromObject(resultMap);
		String param = json.toString();
		System.out.println("json:" + param);
		JSONObject res = JSONObject.fromObject(util.reqPost(
				"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=" + token.getAccess_token(), param));
		System.out.println("WX返回的：" + res);
		if (!"0".equals(res.getString("errcode"))) {

			return name + " ，请联系管理员";
		}

		return appid;
	}

	/**
	 * 淇濆瓨閫氳褰曞埌鏈湴鏁版嵁搴� ---瀵瑰鎻愪緵姝PI锛屽啓鍦–ontroller涓紝褰撴湁浜哄憳鍔犲叆鏃躲�� 璋冪敤姝PI
	 * 鍦≦YWX鍚庡彴鍙互鍦ㄥ悇绉嶆儏鍐典笅鍥炶皟API 鏌ョ湅锛�
	 * https://work.weixin.qq.com/api/doc#90000/90135/90970
	 * 
	 * @param access_token
	 * @param department_id 部门ID号
	 * @param fetch_child   是否遍历部门下所有子部门 1是0不
	 */
	@Override
	@Transactional
	public String saveMembers(String department_id, String fetch_child) {
		AccessToken token = getUsefulToken(MembersSecret, 1, AppID, Corpid);
		String url = "https://qyapi.weixin.qq.com/cgi-bin/user/list";
		String param = "access_token=" + token.getAccess_token() + "&department_id=" + department_id + "&fetch_child="
				+ fetch_child;
		// 发起GET请求
		JSONObject json = JSONObject.fromObject(util.reqGet(url, param));
		System.out.println(json);
		if (json.isEmpty()) // 空返回 true
			return "error: 请求失败";
		JSONArray userlist = json.getJSONArray("userlist");
		Iterator it = userlist.iterator();
		Members members = null;
		SimpleDateFormat sdf = new SimpleDateFormat("MM-dd");
		SimpleDateFormat sdf2 = new SimpleDateFormat("yyyy-MM-dd");
		while (it.hasNext()) {
			JSONObject mem = JSONObject.fromObject(it.next());
			members = mdao.findByUserid(mem.getString("userid"));
			if(members == null)
				members = new Members();
			// System.out.println(it.next()); //it.next() 使用就跳转一下一个			
			// System.out.println("该成员的JSON："+mem);
			members.setUserid(mem.getString("userid"));
			members.setName(mem.getString("name"));
			members.setEnable(Integer.valueOf(mem.getString("enable")));
			members.setAvatar(mem.getString("avatar"));
			// "extattr":{"attrs":[]}
			// "extattr":{"attrs":[{"name":"sss","value":"06-11","type":0,"text":{"value":"06-11"}},{"name":"娴嬭瘯瀛楁","value":"ssss","type":0,"text":{"value":"ssss"}}]},
			if (!mem.getJSONObject("extattr").getJSONArray("attrs").isEmpty()) {
				JSONArray arr = mem.getJSONObject("extattr").getJSONArray("attrs");
				System.out.println("arr" + arr);
				Date birthday = null;
				Date entryTime = null;
				try {
					// 判断是否能分割成三个 ，若是，则为 年-月-日，只取 月日
					if (!arr.getJSONObject(0).getString("value").isEmpty()
							&& arr.getJSONObject(0).getString("value").split("-").length == 3) {
						String[] array = arr.getJSONObject(0).getString("value").split("-");
						birthday = sdf.parse(array[1] + "-" + array[2]);
					} else if (!arr.getJSONObject(0).getString("value").isEmpty()) {
						System.out.println("value=" + arr.getJSONObject(0).getString("value"));
						birthday = sdf.parse(arr.getJSONObject(0).getString("value"));
					}
					// 两个都有的情况"extattr":{"attrs":[{"name":"生日","value":"1996-06-11","type":0,"text":{"value":"1996-06-11"}},
					// {"name":"入职日期","value":"2019-3-11","type":0,"text":{"value":"2019-3-11"}}]}
					// 只有入职日期的情况
					// "extattr":{"attrs":[{"name":"生日","value":"","type":0,"text":{"value":""}},
					// {"name":"入职日期","value":"2019-3-11","type":0,"text":{"value":"2019-3-11"}}]}
					// 都没有
					// "extattr":{"attrs":[{"name":"生日","value":"","type":0,"text":{"value":""}},
					// {"name":"入职日期","value":"","type":0,"text":{"value":""}}]}
					// 判断入职日期 格式 1996-06-11
					if (arr.size() >= 2 && !arr.getJSONObject(1).getString("value").isEmpty()) {
						entryTime = sdf2.parse(arr.getJSONObject(1).getString("value"));
					}
				} catch (ParseException e) {
					System.err.println("请输入日期格式如  1996-06-11 或者 06-11");
					e.printStackTrace();

				}
				members.setBirthday(birthday);
				members.setEntryTime(entryTime);
			}
			mdao.save(members);

		}
		return "更新通讯录成功！";

	}
}
